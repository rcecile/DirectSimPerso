PRO prepa_hist_zs_odds_bdt

dir='/sps/lsst/data/rcecile/TJP_BAO/'
nslice =70

cut=[-99,-0.0285,0.026,0.775,0.894]
namecut=['All ','BDT 90%','BDT 80%','ODDS 90%','ODDS 80%']
ncut = n_elements(cut)
;bdt > -0.0285 90%
;bdt> 0.026 80%
;podds > 0.775 garde en gros 90% des galaxies
;podds > 0.894 garde en gros 80% des galaxies


;interquartile stat
pinterquart = dblarr(nslice,ncut)
pbias = dblarr(nslice,ncut)
poutlier = dblarr(nslice,ncut)
zstat = dblarr(nslice)

; 2D histo
binz=0.01
zmax=3.
x=findgen(zmax/binz+1)*binz
nz = n_elements(x)
all_hist = dindgen(nz,nz,ncut)

; better to do this part in qlogin mode
for i = 0,nslice-1 do begin
   file='file'+strtrim(i,2)+'.fits'
   print,file
   m=mrdfits(dir+file,1,hh,col=['ZS','ZP','PODDS','BDT'])
   zstat[i] = median(m.(0))
   t = (m.(1)-m.(0))/(1.+m.(0))
   zs = m.(0)
   zp = m.(1)

   for ic=0,ncut-1 do begin
      if (ic le 2) then ok = where(m.(3) gt cut[ic],nok) $
                             else ok = where(m.(2) gt cut[ic],nok) 
      print,'N GAL ', nok
      h=hist_2d(zs,zp[ok],bin1=binz,bin2=binz,max1=zmax,max2=zmax,min1=0,min2=0)
      all_hist[*,*,ic] = all_hist[*,*,ic] + h

      RSTAT,t[ok], Med, Hinge1, Hinge2
      pbias[i,ic] = Med
      pinterquart[i,ic] = Hinge2-Hinge1
      out = where(abs(t) gt 3.*pinterquart[i],nout)
      poutlier[i,ic] = double(nout)/double(n_elements(t))*100.

      print,'---- '+ namecut[ic]+'------------------------------------------------------------------------------------------------------'
      print,'stat ',i,zstat[i],'       bias ',pbias[i,ic],'    sigma ',pinterquart[i,ic],'   outlier ',poutlier[i,ic]
      print,'----------------------------------------------------------------------------------------------------------------------'
      print,' '
  endfor
   save,zstat,pinterquart,pbias,poutlier,all_hist,cut,namecut,file=dir+'histo_zs_zp_allstat.sav'
endfor

END
